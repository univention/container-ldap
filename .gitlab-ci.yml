---

stages:
- lint-stage
- build-stage
- test-stage
#- deploy-stage
#- test-stage
#- undeploy-stage

variables:
  UNIV_DOCKERHUB_MIRROR: docker-registry.knut.univention.de
  # We need to turn off TLS or reconfigure GitLab, see:
  # https://about.gitlab.com/releases/
  # 2019/07/31/docker-in-docker-with-docker-19-dot-03/
  DOCKER_TLS_CERTDIR: ""
  # DOCKER_TLS_CERTDIR: "/certs"
  # DOCKER_TLS_VERIFY: 1
  # DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"

  CI_PIPELINE_TAG: "${CI_PIPELINE_ID}-"

pre-commit-job:
  stage: lint-stage
  when: manual
  image: ${UNIV_DOCKERHUB_MIRROR}/pre-commit:container-ldap
  variables:
    PIP_CACHE_DIR: ${CI_PROJECT_DIR}/.cache/pip
    PRE_COMMIT_HOME: ${CI_PROJECT_DIR}/.cache/pre-commit
  cache:
    paths:
    - .cache/pip
    - .cache/pre-commit
    - venv/
  script:
  # Compose lint would fail without the referenced env files
  - cp .env.listener.example .env.listener
  - cp .env.univention-openldap.example .env.univention-openldap
  - pre-commit run --all-files

build-job:
  # Only the debian flavor seems to be working with dind out of the box
  # the alpine as of 1.28.0 does not because of a mismatch issue
  # between "musl libc" vs glibc:
  # https://github.com/docker/compose/issues/3465
  # https://stackoverflow.com/a/42322893
  image: ${UNIV_DOCKERHUB_MIRROR}/docker/compose:debian-1.28.0
  stage: build-stage
  tags:
    - docker
  when: manual
  services:
    - name: ${UNIV_DOCKERHUB_MIRROR}/docker:20.10.2-dind
      alias: docker
      command: ["--insecure-registry=docker-registry.knut.univention.de"]
  script:
    - cp .env.listener.example .env.listener
    - cp .env.univention-openldap.example .env.univention-openldap
    - docker-compose build
    - docker-compose push

#deploy-job:
#  image: ${UNIV_DOCKERHUB_MIRROR}/docker/compose:debian-1.28.0
#  stage: deploy-stage
#  tags:
#    - docker
#  when: manual
#  services:
#    - name: ${UNIV_DOCKERHUB_MIRROR}/docker:20.10.2-dind
#      alias: docker
#      command: ["--insecure-registry=docker-registry.knut.univention.de"]
#  script:
#    - cp .env.listener.example .env.listener
#    - cp .env.univention-openldap.example .env.univention-openldap
#    - docker-compose pull
#    - docker-compose up --detach --no-build

test-job:
  image: ${UNIV_DOCKERHUB_MIRROR}/docker/compose:debian-1.28.0
  stage: test-stage
  tags:
    - docker
  when: manual
  services:
    - name: ${UNIV_DOCKERHUB_MIRROR}/docker:20.10.2-dind
      alias: docker
      command: ["--insecure-registry=docker-registry.knut.univention.de"]
  script:
    - cp .env.listener.example .env.listener
    - cp .env.univention-openldap.example .env.univention-openldap
    - docker-compose pull
    - docker-compose up --detach --no-build
    - cd integration-test
    - docker-compose up
    - docker-compose rm
    - cd -
    - docker-compose down
    - docker-compose rm

#undeploy-job:
#  image: ${UNIV_DOCKERHUB_MIRROR}/docker/compose:debian-1.28.0
#  stage: undeploy-stage
#  tags:
#    - docker
#  when: manual
#  services:
#    - name: ${UNIV_DOCKERHUB_MIRROR}/docker:20.10.2-dind
#      alias: docker
#      command: ["--insecure-registry=docker-registry.knut.univention.de"]
#  script:
#    - docker-compose down
#    - docker-compose rm
...
