<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1195px" preserveAspectRatio="none" style="width:1408px;height:1195px;" version="1.1" viewBox="0 0 1408 1195" width="1408px" zoomAndPan="magnify"><defs><filter height="300%" id="f110lmjl4rd5fo" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><ellipse cx="701.5" cy="20" fill="#000000" filter="url(#f110lmjl4rd5fo)" rx="10" ry="10" style="stroke: none; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="47.9375" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="748" x="327.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="329" x="337.5" y="71.1387">socketserver = slapdsock.service.SlapdSockServer()</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="728" x="337.5" y="85.1074">:handler = slapdsocklistener.LDAPHandler(ReasonableSlapdSockHandler(SlapdSockHandler(BaseRequestHandler)))</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="121" x="641" y="117.9375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="101" x="651" y="139.0762">Start event loop</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="125" x="639" y="171.9063"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="105" x="649" y="193.0449">Connect to NATS</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="353" x="525" y="225.875"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="333" x="535" y="247.0137">Read jornal and send pending old messages to NATS</text><rect fill="#000000" filter="url(#f110lmjl4rd5fo)" height="6" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 1.0;" width="1387" x="10" y="279.8438"/><rect fill="#FFFFFF" filter="url(#f110lmjl4rd5fo)" height="385.6094" style="stroke: #000000; stroke-width: 2.0;" width="244" x="22" y="584.498"/><path d="M202,585.498 L202,593.7949 L192,603.7949 L22,603.7949 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="170" x="25" y="598.4932">Send Messages to NATS</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="47.9375" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="68" y="681.8223"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="114" x="78" y="702.9609">get message from</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="114" x="78" y="716.9297">`outgoing_queue`</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="47.9375" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="190" x="40" y="764.7598"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="145" x="50" y="785.8984">send message to NATS</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="170" x="50" y="799.8672">into LDIF_PRODUCER queue</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="206" x="32" y="847.6973"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="186" x="42" y="868.8359">remove message from journal</text><polygon fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" points="135,620.7949,147,632.7949,135,644.7949,123,632.7949,135,620.7949" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" points="72,926.1074,198,926.1074,210,938.1074,198,950.1074,72,950.1074,60,938.1074,72,926.1074" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="118" x="76" y="941.9155">no SIGINT / SIGTERM</text><rect fill="#FFFFFF" filter="url(#f110lmjl4rd5fo)" height="861.5127" style="stroke: #000000; stroke-width: 2.0;" width="1109" x="276" y="296.6455"/><path d="M378,297.6455 L378,322.2393 L368,332.2393 L276,332.2393 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="279" y="310.6406">SocketServer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="279" y="326.9375">Main Thread</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="199" x="741" y="349.2393"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="179" x="751" y="370.3779">socketserver.serve_forever()</text><rect fill="#000000" filter="url(#f110lmjl4rd5fo)" height="6" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 1.0;" width="1089" x="286" y="403.208"/><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="229" x="306" y="697.502"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="209" x="316" y="718.6406">listen for messages in the socket</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="127.7813" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="241" x="300" y="766.4707"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="111" x="310" y="787.6094">slapdsock.service</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="221" x="310" y="801.5781">.SlapdSockServer.handle_request()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="300" x2="541" y1="809.4082" y2="809.4082"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="300" x2="541" y1="811.4082" y2="811.4082"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="172" x="310" y="825.5469">handle_request simply puts</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="198" x="310" y="839.5156">incoming socket messages into</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="184" x="310" y="853.4844">the `requests` python queue</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="151" x="310" y="867.4531">so that multiple threads</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="116" x="310" y="881.4219">can work on them.</text><polygon fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" points="420.5,636.4746,432.5,648.4746,420.5,660.4746,408.5,648.4746,420.5,636.4746" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" points="357.5,938.6934,483.5,938.6934,495.5,950.6934,483.5,962.6934,357.5,962.6934,345.5,950.6934,357.5,938.6934" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="118" x="361.5" y="954.5015">no SIGINT / SIGTERM</text><rect fill="#FFFFFF" filter="url(#f110lmjl4rd5fo)" height="658.1484" style="stroke: #000000; stroke-width: 2.0;" width="634" x="593" y="420.0098"/><path d="M705,421.0098 L705,445.6035 L695,455.6035 L593,455.6035 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="596" y="434.0049">SocketServer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="596" y="450.3018">Worker Thread</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="178" x="802" y="516.6035"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="158" x="812" y="537.7422">get message from queue</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="85.875" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="235" x="773.5" y="570.5723"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="162" x="783.5" y="591.7109">handler.handle(message)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="773.5" x2="1008.5" y1="599.541" y2="599.541"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="773.5" x2="1008.5" y1="601.541" y2="601.541"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="215" x="783.5" y="615.6797">Execute SlapdSockHandler.handle</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="185" x="783.5" y="629.6484">to parse the socket message</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="213" x="783.5" y="643.6172">and determine the ldap operation</text><polygon fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" points="834,680.4746,948,680.4746,960,692.4746,948,704.4746,834,704.4746,822,692.4746,834,680.4746" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="114" x="834" y="696.2827">ldap_operation_type</text><rect fill="#FFFFFF" filter="url(#f110lmjl4rd5fo)" height="260.8789" style="stroke: #000000; stroke-width: 2.0;" width="268" x="603" y="727.2793"/><path d="M706,728.2793 L706,752.873 L696,762.873 L603,762.873 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="606" y="741.2744">LDAPHandler.</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="74" x="606" y="757.5713">do_result()</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="175" x="649.5" y="779.873"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="155" x="659.5" y="801.0117">write message to journal</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="248" x="613" y="848.8418"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="228" x="623" y="869.9805">put message into `outgoing_queue`</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="61.9063" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="190" x="642" y="914.252"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="141" x="652" y="935.3906">release back-pressure</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="170" x="652" y="949.3594">by removing an object from</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="169" x="652" y="963.3281">the `backpressure_queue`</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="127.7813" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="164" x="891" y="727.2793"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="84" x="901" y="748.418">LDAPHandler.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="56" x="901" y="762.3867">do_add()</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="72" x="901" y="776.3555">do_delete()</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="72" x="901" y="790.3242">do_modify()</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="80" x="901" y="804.293">do_modrdn()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="891" x2="1055" y1="812.123" y2="812.123"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="891" x2="1055" y1="814.123" y2="814.123"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="84" x="901" y="828.2617">add object to</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="144" x="901" y="842.2305">`backpressure_queue`</text><rect fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" height="99.8438" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="1075" y="727.2793"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="84" x="1085" y="748.418">LDAPHandler.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="59" x="1085" y="762.3867">do_bind()</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="75" x="1085" y="776.3555">do_search()</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="12" x="1085" y="790.3242">...</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1075" x2="1179" y1="798.1543" y2="798.1543"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1075" x2="1179" y1="800.1543" y2="800.1543"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="68" x="1085" y="814.293">do nothing</text><polygon fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" points="891,998.1582,891,998.1582,903,1010.1582,891,1022.1582,891,1022.1582,879,1010.1582,891,998.1582" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" points="891,472.6035,903,484.6035,891,496.6035,879,484.6035,891,472.6035" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f110lmjl4rd5fo)" points="828,1042.1582,954,1042.1582,966,1054.1582,954,1066.1582,828,1066.1582,816,1054.1582,828,1042.1582" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="118" x="832" y="1057.9663">no SIGINT / SIGTERM</text><rect fill="#FFFFFF" filter="url(#f110lmjl4rd5fo)" height="72.5938" style="stroke: #000000; stroke-width: 2.0;" width="126" x="1237" y="759.5801"/><path d="M1353,760.5801 L1353,785.1738 L1343,795.1738 L1237,795.1738 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1240" y="773.5752">SocketServer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="1240" y="789.8721">Worker  Thread</text><rect fill="#000000" filter="url(#f110lmjl4rd5fo)" height="6" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 1.0;" width="1089" x="286" y="1098.1582"/><ellipse cx="840.5" cy="1135.1582" fill="#FFFFFF" filter="url(#f110lmjl4rd5fo)" rx="11" ry="11" style="stroke: #000000; stroke-width: 1.0;"/><ellipse cx="840.5" cy="1135.1582" fill="#000000" rx="6" ry="6" style="stroke: #7F7F7F; stroke-width: 1.0;"/><rect fill="#000000" filter="url(#f110lmjl4rd5fo)" height="6" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 1.0;" width="1387" x="10" y="1178.1582"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="701.5" x2="701.5" y1="30" y2="50"/><polygon fill="#A80036" points="697.5,40,701.5,50,705.5,40,701.5,44" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="701.5" x2="701.5" y1="97.9375" y2="117.9375"/><polygon fill="#A80036" points="697.5,107.9375,701.5,117.9375,705.5,107.9375,701.5,111.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="701.5" x2="701.5" y1="151.9063" y2="171.9063"/><polygon fill="#A80036" points="697.5,161.9063,701.5,171.9063,705.5,161.9063,701.5,165.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="701.5" x2="701.5" y1="205.875" y2="225.875"/><polygon fill="#A80036" points="697.5,215.875,701.5,225.875,705.5,215.875,701.5,219.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="135" x2="135" y1="729.7598" y2="764.7598"/><polygon fill="#A80036" points="131,754.7598,135,764.7598,139,754.7598,135,758.7598" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="135" x2="135" y1="812.6973" y2="847.6973"/><polygon fill="#A80036" points="131,837.6973,135,847.6973,139,837.6973,135,841.6973" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="135" x2="135" y1="644.7949" y2="681.8223"/><polygon fill="#A80036" points="131,671.8223,135,681.8223,139,671.8223,135,675.8223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="210" x2="250" y1="938.1074" y2="938.1074"/><polygon fill="#A80036" points="246,791.7441,250,781.7441,254,791.7441,250,787.7441" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="250" x2="250" y1="632.7949" y2="938.1074"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="250" x2="147" y1="632.7949" y2="632.7949"/><polygon fill="#A80036" points="157,628.7949,147,632.7949,157,636.7949,153,632.7949" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="135" x2="135" y1="881.666" y2="926.1074"/><polygon fill="#A80036" points="131,916.1074,135,926.1074,139,916.1074,135,920.1074" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="420.5" x2="420.5" y1="731.4707" y2="766.4707"/><polygon fill="#A80036" points="416.5,756.4707,420.5,766.4707,424.5,756.4707,420.5,760.4707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="420.5" x2="420.5" y1="660.4746" y2="697.502"/><polygon fill="#A80036" points="416.5,687.502,420.5,697.502,424.5,687.502,420.5,691.502" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="495.5" x2="553" y1="950.6934" y2="950.6934"/><polygon fill="#A80036" points="549,805.877,553,795.877,557,805.877,553,801.877" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="553" x2="553" y1="648.4746" y2="950.6934"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="553" x2="432.5" y1="648.4746" y2="648.4746"/><polygon fill="#A80036" points="442.5,644.4746,432.5,648.4746,442.5,652.4746,438.5,648.4746" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="420.5" x2="420.5" y1="894.252" y2="938.6934"/><polygon fill="#A80036" points="416.5,928.6934,420.5,938.6934,424.5,928.6934,420.5,932.6934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="891" x2="891" y1="550.5723" y2="570.5723"/><polygon fill="#A80036" points="887,560.5723,891,570.5723,895,560.5723,891,564.5723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="737" x2="737" y1="813.8418" y2="848.8418"/><polygon fill="#A80036" points="733,838.8418,737,848.8418,741,838.8418,737,842.8418" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="737" x2="737" y1="882.8105" y2="914.252"/><polygon fill="#A80036" points="733,904.252,737,914.252,741,904.252,737,908.252" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="822" x2="737" y1="692.4746" y2="692.4746"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="737" x2="737" y1="692.4746" y2="779.873"/><polygon fill="#A80036" points="733,769.873,737,779.873,741,769.873,737,773.873" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="43" x="741" y="739.9819">RESULT</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="960" x2="1127" y1="692.4746" y2="692.4746"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1127" x2="1127" y1="692.4746" y2="727.2793"/><polygon fill="#A80036" points="1123,717.2793,1127,727.2793,1131,717.2793,1127,721.2793" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="87" x="1131" y="713.6851">Everything else</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="737" x2="737" y1="976.1582" y2="1010.1582"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="737" x2="879" y1="1010.1582" y2="1010.1582"/><polygon fill="#A80036" points="869,1006.1582,879,1010.1582,869,1014.1582,873,1010.1582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1127" x2="1127" y1="827.123" y2="1010.1582"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1127" x2="903" y1="1010.1582" y2="1010.1582"/><polygon fill="#A80036" points="913,1006.1582,903,1010.1582,913,1014.1582,909,1010.1582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="973" x2="973" y1="692.4746" y2="727.2793"/><polygon fill="#A80036" points="969,717.2793,973,727.2793,977,717.2793,973,721.2793" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="157" x="977" y="713.6851">DELETE / MODIFY / MODRDN</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="973" x2="973" y1="855.0605" y2="1010.1582"/><polygon fill="#A80036" points="969,1000.1582,973,1010.1582,977,1000.1582,973,1004.1582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="891" x2="891" y1="656.4473" y2="680.4746"/><polygon fill="#A80036" points="887,670.4746,891,680.4746,895,670.4746,891,674.4746" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="891" x2="891" y1="496.6035" y2="516.6035"/><polygon fill="#A80036" points="887,506.6035,891,516.6035,895,506.6035,891,510.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="966" x2="1191" y1="1054.1582" y2="1054.1582"/><polygon fill="#A80036" points="1187,822.1738,1191,812.1738,1195,822.1738,1191,818.1738" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1191" x2="1191" y1="484.6035" y2="1054.1582"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1191" x2="903" y1="484.6035" y2="484.6035"/><polygon fill="#A80036" points="913,480.6035,903,484.6035,913,488.6035,909,484.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="891" x2="891" y1="1022.1582" y2="1042.1582"/><polygon fill="#A80036" points="887,1032.1582,891,1042.1582,895,1032.1582,891,1036.1582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="420.5" x2="420.5" y1="409.208" y2="636.4746"/><polygon fill="#A80036" points="416.5,626.4746,420.5,636.4746,424.5,626.4746,420.5,630.4746" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="891" x2="891" y1="409.208" y2="472.6035"/><polygon fill="#A80036" points="887,462.6035,891,472.6035,895,462.6035,891,466.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1300" x2="1300" y1="409.208" y2="1098.1582"/><polygon fill="#A80036" points="1296,1088.1582,1300,1098.1582,1304,1088.1582,1300,1092.1582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="420.5" x2="420.5" y1="962.6934" y2="1098.1582"/><polygon fill="#A80036" points="416.5,1088.1582,420.5,1098.1582,424.5,1088.1582,420.5,1092.1582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="891" x2="891" y1="1066.1582" y2="1098.1582"/><polygon fill="#A80036" points="887,1088.1582,891,1098.1582,895,1088.1582,891,1092.1582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="840.5" x2="840.5" y1="383.208" y2="403.208"/><polygon fill="#A80036" points="836.5,393.208,840.5,403.208,844.5,393.208,840.5,397.208" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="840.5" x2="840.5" y1="1104.1582" y2="1124.1582"/><polygon fill="#A80036" points="836.5,1114.1582,840.5,1124.1582,844.5,1114.1582,840.5,1118.1582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="135" x2="135" y1="285.8438" y2="620.7949"/><polygon fill="#A80036" points="131,610.7949,135,620.7949,139,610.7949,135,614.7949" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="840.5" x2="840.5" y1="285.8438" y2="349.2393"/><polygon fill="#A80036" points="836.5,339.2393,840.5,349.2393,844.5,339.2393,840.5,343.2393" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="135" x2="135" y1="950.1074" y2="1178.1582"/><polygon fill="#A80036" points="131,1168.1582,135,1178.1582,139,1168.1582,135,1172.1582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="701.5" x2="701.5" y1="259.8438" y2="279.8438"/><polygon fill="#A80036" points="697.5,269.8438,701.5,279.8438,705.5,269.8438,701.5,273.8438" style="stroke: #A80036; stroke-width: 1.0;"/><!--MD5=[6703b81b587517e7e4368a3eb592368d]
@startuml LDIF Producer Activity Diagram
start

:socketserver = slapdsock.service.SlapdSockServer()
:handler = slapdsocklistener.LDAPHandler(ReasonableSlapdSockHandler(SlapdSockHandler(BaseRequestHandler)));

:Start event loop;
:Connect to NATS;
:Read jornal and send pending old messages to NATS;

fork

partition "Send Messages to NATS" {
repeat
:get message from
`outgoing_queue`;
:send message to NATS
into LDIF_PRODUCER queue;
:remove message from journal;
repeat while ( no SIGINT / SIGTERM )
}

fork again
    partition "SocketServer\nMain Thread" {
        :socketserver.serve_forever();
    fork
        repeat
            :listen for messages in the socket;
            :slapdsock.service
            .SlapdSockServer.handle_request()
            ====
            handle_request simply puts
            incoming socket messages into
            the `requests` python queue
            so that multiple threads
            can work on them.;

        repeat while ( no SIGINT / SIGTERM )

    fork again

        partition "SocketServer\nWorker Thread" {
            repeat
                :get message from queue;
                :handler.handle(message)
                ====
                Execute SlapdSockHandler.handle
                to parse the socket message
                and determine the ldap operation;
                switch (ldap_operation_type)
                case ( RESULT )
                    partition "LDAPHandler.\ndo_result()" {
                        :write message to journal;
                        :put message into `outgoing_queue`;
                        :release back-pressure
                        by removing an object from
                        the `backpressure_queue`;
                    }
                case ( DELETE / MODIFY / MODRDN )
                    :LDAPHandler.
                    do_add()
                    do_delete()
                    do_modify()
                    do_modrdn()
                    ====
                    add object to
                    `backpressure_queue`;
                case ( Everything else )
                    :LDAPHandler.
                    do_bind()
                    do_search()
                    ...
                    ====
                    do nothing;
                endswitch
            repeat while ( no SIGINT / SIGTERM )
        }
    fork again
        partition "SocketServer\nWorker  Thread" {
        }

end fork

stop

@enduml

PlantUML version 1.2020.02(Sun Mar 01 11:22:07 CET 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 17.0.10+7-Ubuntu-122.04.1
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: GB
--></g></svg>
